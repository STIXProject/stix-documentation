#!/usr/bin/env python
# Copyright (c) 2014, The MITRE Corporation. All rights reserved.
# See LICENSE.txt for complete terms.

import sys
from stix.core import STIXPackage, STIXHeader

def parse_stix( pkg ):
    
    # build dict of ID -> title for ttp
    ttp_list = {}
    for tactic in pkg.ttps:
        ttp_list[tactic.id_] = tactic.title
    
    print "== MALWARE =="    
    for tactic in pkg.ttps:
        print "---"
        print "Title : " + tactic.title
        for behave in tactic.behavior.attack_patterns:

            print "CAPEC: " + str(behave.capec_id)
            print "Description: " + str(behave.description)
            
        for sample in tactic.behavior.malware_instances:
    
            print "Sample: " + str(sample.names[0]) 
            print "Type: " + str(sample.types[0])
            
    print "== ACTOR =="
    for actor in pkg.threat_actors:
        for obs in actor.observed_ttps:
            print "RelatedTTP: " + str(ttp_list[obs.item.idref])
            print "Relationship: " + str(obs.relationship)
        print "Title: " + str(actor.title)
        print "Name: " + str(actor.identity.name)

    return 0

if __name__ == '__main__':
    try: fname = sys.argv[1]
    except: exit(1)
    fd = open(fname)
    stix_pkg = STIXPackage.from_xml(fd)

    parse_stix(stix_pkg)
